1. [目次へ](index.md)


# ディスパッチャとタスクスケジューリング
`ディスパッチ`：タスクにCPUの使用権が割り当てられること  
`タスクスケジューリング`：タスクの実行順序

|タスクスケジューリング方式|概要|
|---|---|
|到着順方式|実行可能になったタスク順に、CPUの使用権を割り当てる方式です。タスクに優先度の概念がないので、実行の途中でCPU使用権が奪われることはありません（これを`ノンプリエンプション`といいます）。|
|優先度順方式|タスクにそれぞれ優先度を設定し、その優先度が高いものから順に実行していく方式です。実行中のタスクよりも優先度の高いものが待ち行列に追加されると、実行の途中でCPU使用権が奪われます（これを`プリエンプション`といいます|
|動的優先順位方式|基本的な動きは優先順位方式と同じですが、その優先度を徐々に上げていく（`エージング`）という点が異なる方式です。これによってスタベーションの発生を回避します。|
|ラウンドロビン方式|CPUの使用権を、一定時間（`タイムクォンタム`）ごとに切り替える方式です。<br>実行可能状態になった順番でタスクにCPU使用権が与えられますが、規定時間内に処理が終わらなかった場合は、次のタスクに使用権が与えられ、実行中だったタスクは待ち行列の最後に回されます。|
|多重待ち行列方式|ラウンドロビン方式に優先順位を加味させた方式です。<br>各優先度ごとに待ち行列を持ち、一定時間で処理が終了しなかった場合は、そのタスクの優先度を下げて、下位の待ち行列末尾へと回します。|
|処理時間順方式|タスクの処理時間が、より短いものから順に処理をしていく方式です。実際には実行前に処理時間を予測するのは困難であるため、実装は難しい物があります。<br>`SPT(Shortest Processing Time First)`|
|イベントドリブン方式|マウスによる入力など、環境の変化をタスク切り換えのきっかけ（`トリガ`）としてCPUの使用権を切り替える方式です。GUI操作のOSではおなじみの方式でもあります。|

実行中のタスクが、別のタスクへとCPUの使用権を切り替えられることを`コンテキスト切替え`と呼びます。このコンテキスト切替えが強制的に発生する方式を`プリエンプティブ方式`と言います（その逆が`ノンプリエンプティブ方式`）。


# タスクの排他制御/同期処理
タスクはその生成時に、OSから独立した記憶領域を割り当てられて動作します。  
その記憶領域には、プログラム自身を格納するための領域の他に、タスク内で用いられる領域がある。  

・記憶領域の種類  
`スタック`：タスク内で用いられる変数や関数呼び出しに必要な情報などを格納する記憶領域  
`ヒープ`：メモリを確保する命令を用いることで都度必要に応じて動的に確保する記憶領域  
このOSから独立した記憶領域内で処理を行う分には、複数のタスクが動いていても問題は起きません。  
しかし、ファイルや共有メモリといった、どのタスクからもアクセスできるリソースの場合は、タスク同士で処理がぶつかってしまう恐れがあります。

# セマフォ
一連の処理の中で、2つ以上のタスクが同時に資源（リソース）を奪い合うことで処理に不整合が生じる箇所。これを`クリティカルセクション`と呼びます。  
このクリティカルセクションに入る前後で、問題が生じないように行う処理が排他制御です。  
`セマフォ`というのは、Dijkstra（ダイクストラ）によって考案された、排他制御のためのメカニズムです。  

セマフォの基本概念は単純です。  
`セマフォ変数`に資源の共有状態を記録して、空いていなければ待ち行列に並ぶ。  
セマフォ変数を自由に書き換えることができてしまうと、排他制御が成り立たないので専用命令を使用します。  
|命令|概要|
|---|---|
|P操作<br>資源をロックする|・セマフォ変数Sの中身が1以上の時、Sを`1減算してタスクの実行を継続`します。<br>・セマフォ変数Sの中身が0の時、実行を中断して待ち行列に並びます（ロック済みのためクリティカルセクションに入れない）。|
|V操作<br>資源のロックをアンロックする|・セマフォ変数Sの中身を`1加算`します。<br>・`待ち行列の先頭タスクを実行可能状態に遷移`させます（そのタスクは、再びP操作を試みることが可能になる）。|
セマフォ変数の中身が任意個であるものを`ゼネラルセマフォ`（計数セマフォ）、0と1に限定されたものを`バイナリセマフォ`と呼びます。  

# デッドロック
排他制御において、複数の資源をそれぞれのタスクが無秩序にロックしていくと、互いに相手のロックしている資源の解除待ちに入ってしまし、処理が進行しなくなるという現象が起こりえます。  
これを`デッドロック`と言います。

これを避けるためには、`資源のロック順序を両方のタスクで同じに揃えること`です。順序がおなじであれば、順序資源の解放に応じて次のタスクがロックできるようになるので、この問題は生じません。

# 同期制御とイベントフラグ
タスクは必ずしもそれ単独で動作するばかりではありません。タスク同士が互いに依存関係を持ち、一方の処理を待って他方が実行を再開するといった協調動作も行われます。  
このような、タスク同士を強調させるために実行タイミングを図る仕組みを、`同期制御`と呼びます。

# タスク間の通信
タスク間の通信に用いられる代表的な手段としては、次のようなものがあります。
|通信手段|詳細|
|---|---|
|共有メモリ(Shared Memory)|メモリ上、複数のタスクから利用できる記憶領域を設けてデータ交換を行います。|
|メッセージキュー|キューというのは、簡単に言えば待ち行列のことです。メッセージ処理用のキューにタスクからのデータをメッセージとして送信し、受信側はこのキューを介してデータを受け取ります。|
|パイプ|仮想的なパイプを通してデータをやり取りする仕組み。あるタスクの出力を、もう一方のタスクに入力として接続し、データを転送します。|
